services:
  # Traefik API Gateway - Punto de entrada único
  traefik:
    image: traefik:v2.11
    command:
      - "--api.insecure=true"  # Dashboard en :8090
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--log.level=INFO"
    ports:
      - "80:80"      # Puerto público del API Gateway
      - "8090:8080"  # Dashboard de Traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    networks:
      - biblioteca-network

  db:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: lib
    ports: ["5433:5432"]
    restart: unless-stopped
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - biblioteca-network

  api:
    build: .
    env_file: .env
    expose: ["8080"]  # Ya no exponemos directamente, solo a Traefik
    depends_on: [db, redis, traefik]
    restart: unless-stopped
    command: gunicorn -w 2 -b 0.0.0.0:8080 --reload app.wsgi:app
    volumes:
      - ./app:/app/app
      - ./infrastructure:/app/infrastructure
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=PathPrefix(`/api`) || PathPrefix(`/auth`) || PathPrefix(`/catalog`) || PathPrefix(`/inventory`) || PathPrefix(`/loans`) || PathPrefix(`/users`) || PathPrefix(`/waitlist`) || PathPrefix(`/notifications`) || PathPrefix(`/reports`) || PathPrefix(`/health`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.services.api.loadbalancer.server.port=8080"
      # CORS Middleware
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,PATCH,OPTIONS"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowheaders=Content-Type,Authorization"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolalloworiginlist=http://localhost:3000,http://localhost:4200,http://localhost:5173"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.api-cors.headers.addvaryheader=true"
      - "traefik.http.routers.api.middlewares=api-cors"
    networks:
      - biblioteca-network

  worker:
    build:
      context: .
      dockerfile: worker.Dockerfile
    env_file: .env
    environment:
      - PYTHONPATH=/app
    command: celery -A infrastructure.celery_app.celery worker -l info -Q default,waitlist,events
    depends_on:
      - db
      - redis
    restart: unless-stopped
    volumes:
      - ./app:/app/app
      - ./infrastructure:/app/infrastructure
    networks:
      - biblioteca-network

  redis:
    image: redis:7
    ports: ["6379:6379"]
    restart: unless-stopped
    networks:
      - biblioteca-network

  flower:
    build:
      context: .
      dockerfile: worker.Dockerfile
    env_file: .env
    environment:
      - PYTHONPATH=/app
      - FLOWER_BASIC_AUTH=${FLOWER_BASIC_AUTH}
    command: celery -A infrastructure.celery_app.celery flower --port=5555
    expose: ["5555"]  # Solo interno
    depends_on:
      - redis
      - api
      - traefik
    restart: unless-stopped
    volumes:
      - ./app:/app/app
      - ./infrastructure:/app/infrastructure
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.flower.rule=PathPrefix(`/flower`)"
      - "traefik.http.routers.flower.entrypoints=web"
      - "traefik.http.services.flower.loadbalancer.server.port=5555"
    networks:
      - biblioteca-network

volumes:
  postgres_data:

networks:
  biblioteca-network:
    driver: bridge

